<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Administration</title>
    
    <!-- CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        body {
            background-color: #ecf0f1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }

        .stat-card .card-body {
            text-align: center;
            padding: 25px 15px;
        }

        .stat-card h5 {
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stat-card h3 {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 2rem;
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .table-responsive {
            border-radius: 10px;
        }

        #userTable tbody tr {
            transition: background-color 0.2s ease;
        }

        #userTable tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                margin-bottom: 20px;
                position: static;
            }
        }
    </style>
</head>
<body>

    <!-- Notification Alert -->
    <div id="notificationAlert" class="alert alert-notification alert-dismissible fade show" role="alert">
        <span id="alertMessage"></span>
        <button type="button" class="btn-close" onclick="hideNotification()"></button>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold">
                <i class="bi bi-speedometer2 me-2"></i>Tableau de Bord Administration
            </span>
            <span class="text-light">Gestion des Utilisateurs</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Colonne de Contrôle -->
            <div class="col-lg-3 col-md-4">
                <div class="sidebar card">
                    <div class="card-header">
                        <i class="bi bi-funnel me-2"></i> Filtres et Actions
                    </div>
                    <div class="card-body">
                        <!-- Section Chargement -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Chargement des données</h6>
                            <button id="loadDataBtn" class="btn btn-primary w-100 mb-3">
                                <i class="bi bi-cloud-download me-2"></i> Charger les données
                            </button>
                            <div class="loading-spinner" id="loadingSpinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement en cours...</p>
                            </div>
                        </div>

                        <!-- Section Recherche -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Recherche</h6>
                            <div class="mb-3">
                                <label for="searchInput" class="form-label">Recherche rapide</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Nom, Email, Société...">
                            </div>
                        </div>

                        <!-- Section Filtres -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Filtres</h6>
                            <div class="mb-3">
                                <label for="daterange" class="form-label">Filtrer par date</label>
                                <input type="text" id="daterange" class="form-control" />
                            </div>
                        </div>

                        <!-- Section Export -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Export des données</h6>
                            <button id="exportExcelBtn" class="btn btn-success w-100 mb-2">
                                <i class="bi bi-file-earmark-excel me-2"></i> Exporter en Excel
                            </button>
                            <button id="generatePdfBtn" class="btn btn-danger w-100 mb-2">
                                <i class="bi bi-file-earmark-pdf me-2"></i> Générer PDF
                            </button>
                        </div>
                        
                        <!-- Section Administration -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Administration</h6>
                            <button id="showDuplicatesBtn" class="btn btn-warning w-100 mb-2">
                                <i class="bi bi-exclamation-triangle me-2"></i> Détecter les doublons
                            </button>
                            <button id="resetFiltersBtn" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-arrow-clockwise me-2"></i> Réinitialiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne d'Affichage Principal -->
            <div class="col-lg-9 col-md-8">
                <!-- Cartes de Statistiques -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="bi bi-people-fill display-6 text-primary mb-3"></i>
                                <h5>Total Utilisateurs</h5>
                                <h3 id="totalUsers">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="bi bi-person-plus display-6 text-success mb-3"></i>
                                <h5>Nouveaux (30 jours)</h5>
                                <h3 id="newUsers">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="bi bi-globe display-6 text-warning mb-3"></i>
                                <h5>Pays principal</h5>
                                <h3 id="topCountry">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="bi bi-person-badge display-6 text-info mb-3"></i>
                                <h5>Type principal</h5>
                                <h3 id="topUserType">-</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-bar-chart me-2"></i> Répartition par pays
                    </div>
                    <div class="card-body">
                        <canvas id="userChart" height="150"></canvas>
                    </div>
                </div>

                <!-- Tableau de données -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-table me-2"></i> Liste des Utilisateurs
                        </div>
                        <span class="badge bg-primary" id="tableCount">0 utilisateurs</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="userTable" class="table table-hover" style="width:100%">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nom Complet</th>
                                        <th>Email</th>
                                        <th>Téléphone</th>
                                        <th>Société</th>
                                        <th>Pays</th>
                                        <th>Type</th>
                                        <th>Date de création</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Les données seront injectées ici par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS CDN -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Initialisation Supabase :cite[4]
        const { jsPDF } = window.jspdf;
        const supabaseUrl = 'https://godhvvxapbtghchfrcxz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvZGh2dnhhcGJ0Z2hjaGZyY3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDEyMDgsImV4cCI6MjA3NDY3NzIwOH0.RK0-YEzLACd8BuCtmwfRNZEgNKlxD5pjQHCraqXANNs';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Variables globales
        let allUserData = [];
        let filteredUserData = [];
        let dataTable;
        let userChart;

        // Écouteurs d'événements au chargement du DOM
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateRangePicker();
            initializeChart();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('loadDataBtn').addEventListener('click', fetchUserData);
            document.getElementById('searchInput').addEventListener('keyup', applyFilters);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('generatePdfBtn').addEventListener('click', generatePdfReport);
            document.getElementById('showDuplicatesBtn').addEventListener('click', findAndShowDuplicates);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
        }

        // --- Fonctions de récupération et de traitement des données --- :cite[4]

        async function fetchUserData() {
            showLoading(true);
            
            try {
                const { data, error } = await supabase
                    .from('userData')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw new Error(`Erreur Supabase: ${error.message}`);
                }
                
                allUserData = data || [];
                filteredUserData = [...allUserData];
                
                updateDashboard();
                showNotification('Données chargées avec succès !', 'success');
            } catch (error) {
                console.error('Erreur de récupération des données:', error);
                showNotification('Erreur lors du chargement des données: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateRange = $('#daterange').data('daterangepicker');
            const startDate = dateRange.startDate.toISOString();
            const endDate = dateRange.endDate.toISOString();

            filteredUserData = allUserData.filter(user => {
                const matchesSearch = !searchTerm || 
                    (user.fullname && user.fullname.toLowerCase().includes(searchTerm)) ||
                    (user.mail && user.mail.toLowerCase().includes(searchTerm)) ||
                    (user.societe && user.societe.toLowerCase().includes(searchTerm));
                
                const createdAtDate = new Date(user.created_at).toISOString();
                const matchesDate = createdAtDate >= startDate && createdAtDate <= endDate;

                return matchesSearch && matchesDate;
            });

            updateDashboard();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            
            // Réinitialiser le date range picker
            const start = moment().subtract(29, 'days');
            const end = moment();
            $('#daterange').data('daterangepicker').setStartDate(start);
            $('#daterange').data('daterangepicker').setEndDate(end);
            
            applyFilters();
            showNotification('Filtres réinitialisés', 'info');
        }

        // --- Fonctions de mise à jour de l'interface ---

        function updateDashboard() {
            updateStatistics();
            updateChart();
            updateDataTable();
            updateTableCount();
        }

        function updateStatistics() {
            document.getElementById('totalUsers').textContent = filteredUserData.length.toLocaleString();
            
            // Nouveaux utilisateurs (30 derniers jours)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const newUsersCount = filteredUserData.filter(user => new Date(user.created_at) >= thirtyDaysAgo).length;
            document.getElementById('newUsers').textContent = newUsersCount.toLocaleString();

            // Pays le plus représenté
            const countryCounts = {};
            filteredUserData.forEach(user => {
                if (user.country) {
                    countryCounts[user.country] = (countryCounts[user.country] || 0) + 1;
                }
            });
            const topCountry = Object.keys(countryCounts).length > 0 ? 
                Object.keys(countryCounts).reduce((a, b) => countryCounts[a] > countryCounts[b] ? a : b) : '-';
            document.getElementById('topCountry').textContent = topCountry;

            // Type d'utilisateur principal
            const typeCounts = {};
            filteredUserData.forEach(user => {
                if (user.type_user) {
                    typeCounts[user.type_user] = (typeCounts[user.type_user] || 0) + 1;
                }
            });
            const topType = Object.keys(typeCounts).length > 0 ? 
                Object.keys(typeCounts).reduce((a, b) => typeCounts[a] > typeCounts[b] ? a : b) : '-';
            document.getElementById('topUserType').textContent = topType;
        }

        function updateChart() {
            const countryCounts = {};
            filteredUserData.forEach(user => {
                if (user.country) {
                    countryCounts[user.country] = (countryCounts[user.country] || 0) + 1;
                }
            });

            // Trier par nombre d'utilisateurs (descendant) et prendre les 10 premiers
            const sortedCountries = Object.entries(countryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedCountries.map(item => item[0]);
            const data = sortedCountries.map(item => item[1]);

            userChart.data.labels = labels;
            userChart.data.datasets[0].data = data;
            userChart.update();
        }

        function updateDataTable() {
            if (dataTable) {
                dataTable.clear();
                dataTable.rows.add(filteredUserData);
                dataTable.draw();
            } else {
                dataTable = $('#userTable').DataTable({
                    data: filteredUserData,
                    columns: [
                        { data: 'id' },
                        { data: 'fullname' },
                        { data: 'mail' },
                        { data: 'phone' },
                        { data: 'societe' },
                        { data: 'country' },
                        { data: 'type_user' },
                        { 
                            data: 'created_at',
                            render: function(data) {
                                return new Date(data).toLocaleString('fr-FR');
                            }
                        }
                    ],
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: '<i class="bi bi-file-earmark-excel me-2"></i>Exporter en Excel',
                            className: 'btn btn-success',
                            title: 'Utilisateurs'
                        }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json"
                    },
                    pageLength: 25,
                    responsive: true,
                    order: [[0, 'desc']]
                });
            }
        }

        function updateTableCount() {
            const count = filteredUserData.length;
            document.getElementById('tableCount').textContent = `${count} utilisateur${count !== 1 ? 's' : ''}`;
        }

        // --- Fonctions d'initialisation des plugins ---

        function initializeDateRangePicker() {
            const start = moment().subtract(29, 'days');
            const end = moment();

            $('#daterange').daterangepicker({
                startDate: start,
                endDate: end,
                locale: {
                    format: 'DD/MM/YYYY',
                    separator: ' - ',
                    applyLabel: 'Appliquer',
                    cancelLabel: 'Annuler',
                    fromLabel: 'De',
                    toLabel: 'à',
                    customRangeLabel: 'Personnalisé',
                    weekLabel: 'S',
                    daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
                    monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
                    firstDay: 1
                },
                ranges: {
                    'Aujourd\'hui': [moment(), moment()],
                    'Hier': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Les 7 derniers jours': [moment().subtract(6, 'days'), moment()],
                    'Les 30 derniers jours': [moment().subtract(29, 'days'), moment()],
                    'Ce mois-ci': [moment().startOf('month'), moment().endOf('month')],
                    'Le mois dernier': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, applyFilters);
        }

        function initializeChart() {
            const ctx = document.getElementById('userChart').getContext('2d');
            userChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nombre d\'utilisateurs',
                        data: [],
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // --- Fonctions d'export et de gestion des doublons ---

        function exportToExcel() {
            if (dataTable) {
                dataTable.button(0).trigger();
            } else {
                showNotification('Veuillez d\'abord charger les données', 'warning');
            }
        }

        function generatePdfReport() {
            if (filteredUserData.length === 0) {
                showNotification("Aucune donnée à exporter. Veuillez d'abord charger les données.", 'warning');
                return;
            }

            showNotification("Génération du PDF en cours...", 'info');

            // Créer un PDF simple avec les données du tableau
            const pdf = new jsPDF('p', 'mm', 'a4');
            const dateRange = $('#daterange').data('daterangepicker');
            
            pdf.text('Rapport des Utilisateurs', 20, 20);
            pdf.text(`Période: du ${dateRange.startDate.format('DD/MM/YYYY')} au ${dateRange.endDate.format('DD/MM/YYYY')}`, 20, 30);
            pdf.text(`Total utilisateurs: ${filteredUserData.length}`, 20, 40);
            
            let yPosition = 60;
            pdf.text('Liste des utilisateurs:', 20, yPosition);
            yPosition += 10;

            // En-têtes du tableau
            pdf.text('ID', 20, yPosition);
            pdf.text('Nom', 40, yPosition);
            pdf.text('Email', 80, yPosition);
            pdf.text('Société', 140, yPosition);
            yPosition += 5;
            pdf.line(20, yPosition, 190, yPosition);
            yPosition += 10;

            // Données du tableau (limitées pour éviter le débordement)
            filteredUserData.slice(0, 20).forEach(user => {
                if (yPosition > 270) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                pdf.text(user.id.toString(), 20, yPosition);
                pdf.text(user.fullname || '-', 40, yPosition);
                pdf.text(user.mail || '-', 80, yPosition);
                pdf.text(user.societe || '-', 140, yPosition);
                yPosition += 10;
            });

            pdf.save(`rapport_utilisateurs_${moment().format('YYYY-MM-DD_HH-mm')}.pdf`);
            showNotification('PDF généré avec succès!', 'success');
        }

        function findAndShowDuplicates() {
            if (allUserData.length === 0) {
                showNotification("Veuillez d'abord charger les données.", 'warning');
                return;
            }

            const seenMails = new Map();
            const seenPhones = new Map();
            const duplicateIds = new Set();

            allUserData.forEach(user => {
                if (user.mail) {
                    if (seenMails.has(user.mail)) {
                        duplicateIds.add(seenMails.get(user.mail));
                        duplicateIds.add(user.id);
                    } else {
                        seenMails.set(user.mail, user.id);
                    }
                }
                if (user.phone) {
                    if (seenPhones.has(user.phone)) {
                        duplicateIds.add(seenPhones.get(user.phone));
                        duplicateIds.add(user.id);
                    } else {
                        seenPhones.set(user.phone, user.id);
                    }
                }
            });

            filteredUserData = allUserData.filter(user => duplicateIds.has(user.id));
            
            if (filteredUserData.length === 0) {
                showNotification("Aucun doublon trouvé (basé sur l'email ou le téléphone).", 'info');
                filteredUserData = [...allUserData];
            } else {
                showNotification(`${filteredUserData.length} entrées potentiellement en double trouvées.`, 'warning');
            }
            
            updateDashboard();
        }

        // --- Fonctions utilitaires ---

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('loadDataBtn').style.display = show ? 'none' : 'block';
        }

        function showNotification(message, type = 'info') {
            const alert = document.getElementById('notificationAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            alert.className = `alert alert-${type} alert-notification alert-dismissible fade show`;
            alertMessage.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            document.getElementById('notificationAlert').style.display = 'none';
        }
    </script>
</body>
</html>